apiVersion: batch/v1
kind: Job
metadata:
  name: openstack-appcred-{{ .Values.appCred.cluster_name }}
  namespace: {{ .Values.appCred.cluster_name }}
spec:
  template:
    metadata:
      name: openstack-appcred-job-{{ .Values.appCred.cluster_name }}
      labels: openstack-appcred-{{ .Values.appCred.cluster_name }}
    spec:
      serviceAccountName: appcreds-writer
      restartPolicy: {{ .Values.restartPolicy }}

      securityContext:
        runAsNonRoot: true              # required by PSS:restricted
        # If your image has a known non-root UID, set it explicitly (example):
        runAsUser: 10001
        seccompProfile:
          type: RuntimeDefault          # required by PSS:restricted
        # Optional but often recommended:
        # fsGroup: 10001

      containers:
        - name: writer
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: IfNotPresent

          # ---------- Container-level securityContext ----------
          securityContext:
            allowPrivilegeEscalation: false          # required by PSS:restricted
            capabilities:
              drop: ["ALL"]                          # required by PSS:restricted
            # Optional hardening:
            # readOnlyRootFilesystem: true
          env:
            # Select cloud entry from clouds.yaml
            - name: OS_CLOUD
              value: "{{ .Values.os_cloud }}"

            # App credential creation settings
            - name: APP_CRED_NAME
              value: "{{ .Values.appCred.name }}"
            - name: APP_CRED_ROLES
              value: "{{ .Values.appCred.roles }}"
            - name: APP_CRED_EXPIRES_IN
              value: "{{ .Values.appCred.expires_in }}"
            - name: APP_CRED_EXPIRES_AT
              value: "{{ .Values.appCred.expires_at }}"
            - name: APP_CRED_DESCRIPTION
              value: "{{ .Values.appCred.description }}"
            - name: APP_CRED_UNRESTRICTED
              value: "{{ .Values.appCred.unrestricted }}"
            - name: APP_CRED_IF_EXISTS
              value: "{{ .Values.appCred.if_exists }}"

            # Secret output config
            - name: OUTPUT_SECRET_NAME
              value: "{{ .Values.appCred.cluster_name }}"
            - name: OUTPUT_SECRET_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          volumeMounts:
            - name: clouds
              mountPath: /etc/openstack
              readOnly: true
            - name: custom-ca
              mountPath: /etc/ssl/certs/ca.crt
              subPath: ca.crt
              readOnly: true

      volumes:
        - name: clouds
          secret:
            secretName: openstack-clouds
        - name: custom-ca        
          configMap:        
            name: custom-ca-bundle        
            items:        
              - key: ca.crt
                path: ca.crt